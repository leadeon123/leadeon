(function(){var Widget = Frame.regNamespace("Widget");(function(){var List = Frame.Widget.regNamespace("List");var nSelectOptionHeight = null, nSelectBorderHeight = null;function SingleList(oDomContainer, oOption){if("DIV" != oDomContainer.tagName.toUpperCase()) return;var win = Frame.Util.getWindowByElement(oDomContainer);var winDoc = win.document;var oDomDivTitle = winDoc.createElement("DIV");var oDomSpanTitle = winDoc.createElement("SPAN");var oDomSelectList = winDoc.createElement("SELECT");oDomDivTitle.appendChild(oDomSpanTitle);oDomContainer.appendChild(oDomDivTitle);oDomContainer.appendChild(oDomSelectList);oDomSelectList.multiple = "multiple";oDomSelectList.style.padding = "0px";oDomSelectList.style.margin = "0px";var sListWidth = "160px", sListHeight = "250px", aData = [], aToSelect = [];function arrayPub(a, b){var aResult = [], aSwitch = [];for(var i=0; i < b.length; i++) aSwitch["s" + b[i]] = i; for(var i=0; i < a.length; i++) {if(("s" + a[i]) in aSwitch) aResult.push(a[i]);}return aResult;}function arraySub(a, b) {   var aResult = [], aSwitch = [];for(var i=0; i < b.length; i++) aSwitch["s" + b[i]] = i;for(var i=0; i < a.length; i++){if(!(("s" + a[i]) in aSwitch)) aResult.push(a[i]);}return aResult;}function isVisible(){return !(0 == oDomContainer.offsetHeight || 0 == oDomContainer.offsetWidth);}        function getSelected(){var aOptions = oDomSelectList.options;var nSelectedIndex = oDomSelectList.selectedIndex;var aSelected = [];if(-1 != nSelectedIndex){for(var i = nSelectedIndex; i < aOptions.length; i++){if(true == aOptions[i].selected){aSelected.push(aOptions[i].text);}}}return aSelected;}function setWidth(sWidth){sListWidth = sWidth||sListWidth;if(!isVisible()) return;oDomSelectList.style.width = "auto";oDomSelectList.style.width = Math.max(parseInt(sListWidth)||0, oDomSelectList.offsetWidth, oDomDivTitle.offsetWidth).toString() + "px";}function setHeight(sHeight) {sListHeight = sHeight||sListHeight;if(!isVisible()) return;if("IE" == Frame.RunState.Navigator.Type && (null == nSelectOptionHeight || null == nSelectBorderHeight)){var nHeight1,nHeight2; oDomSelectList.size = "1";nHeight1 = oDomSelectList.offsetHeight;oDomSelectList.size = "2";nHeight2 = oDomSelectList.offsetHeight;nSelectOptionHeight = nHeight2 - nHeight1; nSelectBorderHeight = nHeight1 - nSelectOptionHeight; }if(null != nSelectOptionHeight && null != nSelectBorderHeight && !isNaN(parseInt(sListHeight))){oDomSelectList.size = Math.round((parseInt(sListHeight)-nSelectBorderHeight)/nSelectOptionHeight).toString();}else oDomSelectList.style.height = sListHeight;}this.getSelected = getSelected;this.getAll = function(){return aData.concat();}this.setTitle = function(sTitle){if(null != sTitle){oDomSpanTitle.innerHTML = sTitle.parseUnicode().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ /g,"&nbsp;");}}this.setWidth = setWidth;this.setHeight = setHeight;function show(oDomSelect, aData, aSelect) {if("Array" != Frame.Util.getType(aSelect)) aSelect = [];aToSelect = aSelect.concat();var aDisplay = aData;if("Array" == Frame.Util.getType((oOption||{}).aOrderBy)){oOption.aOrderBy = oOption.aOrderBy.concat(arraySub(aDisplay, oOption.aOrderBy)); aDisplay = arrayPub(oOption.aOrderBy, aDisplay); }if(!isVisible()) return; var aSwitch = [];for(var i=0; i < aSelect.length; i++) aSwitch["s" + aSelect[i]] = i;var oDomFragment = winDoc.createDocumentFragment();for(var i=0; i< aDisplay.length; i++){var oDomOption = winDoc.createElement("OPTION");oDomFragment.appendChild(oDomOption);oDomOption.text = aDisplay[i];if(("s" + aDisplay[i]) in aSwitch) oDomOption.selected = true;}oDomSelect.innerHTML = "";oDomSelect.appendChild(oDomFragment);setWidth();setHeight();}this.add = function(aValue, aSelect){if("Array" != Frame.Util.getType(aValue)) return [];var aAdd = arraySub(aValue, aData);aData = aData.concat(aAdd);show(oDomSelectList, aData, aSelect);return aAdd; }this.remove = function(aValue, aSelect){if("Array" != Frame.Util.getType(aValue)) return [];var aRemove = arrayPub(aData, aValue);aData = arraySub(aData, aRemove);show(oDomSelectList, aData, aSelect);return aRemove; }this.select = function(aValue){if("Array" != Frame.Util.getType(aValue)) aValue = [];show(oDomSelectList, aData, aValue);return arrayPub(aData, aValue); }this.disable = function(bDisabled){if(undefined === bDisabled) bDisabled = true;oDomSelectList.disabled = bDisabled;}this.setWidth(); this.setHeight(); var bVisibleNow = isVisible();win.setInterval(function(){var bVisiblePre = bVisibleNow;bVisibleNow = isVisible();if(false == bVisiblePre && true == bVisibleNow) {show(oDomSelectList, aData, aToSelect);}else if(true == bVisiblePre && false == bVisibleNow) {aToSelect = getSelected();}}, 50);}function CoupleList(oDomContainer, oOption){var winDoc = Frame.Util.getWindowByElement(oDomContainer).document;var oDomTable = winDoc.createElement("TABLE");var oDomTbody = winDoc.createElement("TBODY");var oDomTr = winDoc.createElement("TR");var oDomTdLeft = winDoc.createElement("TD");var oDomTdMiddle = winDoc.createElement("TD");var oDomTdRight = winDoc.createElement("TD");var oDomDivLeft = winDoc.createElement("DIV");var oDomDivMiddle = winDoc.createElement("DIV");var oDomDivRight = winDoc.createElement("DIV");oDomContainer.appendChild(oDomTable);oDomTable.appendChild(oDomTbody);        oDomTbody.appendChild(oDomTr);oDomTr.appendChild(oDomTdLeft);oDomTr.appendChild(oDomTdMiddle);oDomTr.appendChild(oDomTdRight);oDomTdLeft.appendChild(oDomDivLeft);oDomTdMiddle.appendChild(oDomDivMiddle);oDomTdRight.appendChild(oDomDivRight);oDomTdMiddle.style.width="60px";oDomTdMiddle.align="center";oDomTdMiddle.valign="middle";var oListDest = new SingleList(oDomDivLeft, oOption);var oListSrc = new SingleList(oDomDivRight, oOption);this.src = oListSrc;this.dest = oListDest;function OnMouseOver(){this.className='buttonX_over';this.style.fontFamily = '"Batang","Gulim","Arial","Helvetica"';}function OnMouseOut(){this.className='buttonX';this.style.fontFamily = '"Batang","Gulim","Arial","Helvetica"';}var oDomButtonLeft = winDoc.createElement("INPUT");oDomButtonLeft.type = "button";oDomButtonLeft.value = "<<";oDomButtonLeft.onmouseover = OnMouseOver;oDomButtonLeft.onmouseout = OnMouseOut;oDomButtonLeft.onmouseout();var oDomButtonRight = winDoc.createElement("INPUT");oDomButtonRight.type = "button";oDomButtonRight.value = ">>";oDomButtonRight.onmouseover = OnMouseOver;oDomButtonRight.onmouseout = OnMouseOut;oDomButtonRight.onmouseout();oDomDivMiddle.appendChild(oDomButtonLeft);oDomDivMiddle.appendChild(winDoc.createElement("BR"));oDomDivMiddle.appendChild(winDoc.createElement("BR"));oDomDivMiddle.appendChild(oDomButtonRight);function moveAndSelect(src, dest){var aSelected = src.getSelected();if(0 == aSelected.length) return;var aMove = src.remove(aSelected);dest.add(aMove, aMove);}oDomButtonLeft.onclick = function(){moveAndSelect(oListSrc, oListDest);}oDomButtonRight.onclick = function(){moveAndSelect(oListDest, oListSrc);}this.disable = function(bDisabled){if(undefined === bDisabled) bDisabled = true;oDomButtonLeft.disabled = bDisabled;oDomButtonRight.disabled = bDisabled;oListDest.disable(bDisabled);oListSrc.disable(bDisabled);}this.setTitle = function(sTitleSrc, sTitleDest){oListSrc.setTitle(sTitleSrc);oListDest.setTitle(sTitleDest);}this.setWidth = function(sWidth){oListSrc.setWidth(sWidth);oListDest.setWidth(sWidth);}this.setHeight = function(sHeight){oListSrc.setHeight(sHeight);oListDest.setHeight(sHeight);}}function InputList(oDomContainer, oOption){var winDoc = Frame.Util.getWindowByElement(oDomContainer).document;var oDomTable = winDoc.createElement("TABLE");var oDomTbody = winDoc.createElement("TBODY");var oDomTr = winDoc.createElement("TR");var oDomTdLeft = winDoc.createElement("TD");var oDomTdMiddle = winDoc.createElement("TD");var oDomTdRight = winDoc.createElement("TD");var oDomDivLeft = winDoc.createElement("DIV");var oDomDivMiddle = winDoc.createElement("DIV");var oDomDivRight = winDoc.createElement("DIV");oDomContainer.appendChild(oDomTable);oDomTable.appendChild(oDomTbody);        oDomTbody.appendChild(oDomTr);oDomTr.appendChild(oDomTdLeft);oDomTr.appendChild(oDomTdMiddle);oDomTr.appendChild(oDomTdRight);oDomTdLeft.appendChild(oDomDivLeft);oDomTdMiddle.appendChild(oDomDivMiddle);oDomTdRight.appendChild(oDomDivRight);oDomTdMiddle.style.width="60px";oDomTdMiddle.vAlign="top";oDomTdRight.vAlign="top";var oListDest = new SingleList(oDomDivLeft, oOption);var oDomInputSrc = winDoc.createElement("INPUT");var oDomSpanListSrcDes = winDoc.createElement("SPAN");oDomInputSrc.setAttribute("wType","custom"); oDomInputSrc.setAttribute("empty","true"); oDomDivRight.appendChild(oDomInputSrc);oDomDivRight.appendChild(oDomSpanListSrcDes);this.src = oDomInputSrc;this.dest = oListDest;var oDomButtonAdd = winDoc.createElement("INPUT");oDomButtonAdd.type = "button";oDomButtonAdd.value = top.RS_ADD;oDomButtonAdd.className = "buttonX";oDomButtonAdd.onmouseover = function(){this.className='buttonX_over';}oDomButtonAdd.onmouseout = function(){this.className='buttonX';}var oDomButtonDel = winDoc.createElement("INPUT");oDomButtonDel.type = "button";oDomButtonDel.value = top.RS_DELETE;oDomButtonDel.className = "buttonX";oDomButtonDel.onmouseover = function(){this.className='buttonX_over';}oDomButtonDel.onmouseout = function(){this.className='buttonX';}oDomDivMiddle.appendChild(oDomButtonAdd);oDomDivMiddle.appendChild(oDomButtonDel);oDomButtonAdd.onclick = function(){var value = oOption.fnCheck(oDomInputSrc.value);if (value == false){oDomInputSrc.select();oDomInputSrc.focus();}else{oListDest.add([value], [value]);}}oDomButtonDel.onclick = function(){oListDest.remove(oListDest.getSelected());}this.setTitle = function(sTitleSrc, sTitleDest){oListDest.setTitle(sTitleDest);oDomSpanListSrcDes.innerHTML = sTitleSrc;}this.setWidth = function(sWidth){oDomInputSrc.style.width = sWidth;oListDest.setWidth(sWidth);}}List.SingleList = SingleList;   List.CoupleList = CoupleList;   List.InputList = InputList;     })();(function(){var aPuckerClassName = {root:   "pucker_root",closed: "pucker_closed",open:   "pucker_open",none:   "pucker_none"};var aCheckboxClassName = {unchecked_normal:       "checkbox_unchecked_normal",unchecked_disabled:     "checkbox_unchecked_disabled",unchecked_onmouseover:  "checkbox_unchecked_onmouseover",checked_normal:         "checkbox_checked_normal",checked_disabled:       "checkbox_checked_disabled",checked_onmouseover:    "checkbox_checked_onmouseover",halfchecked_normal:     "checkbox_halfchecked_normal",halfchecked_disabled:   "checkbox_halfchecked_disabled",halfchecked_onmouseover:"checkbox_halfchecked_onmouseover"};var aRadioClassName = {unchecked_normal:       "radio_unchecked_normal",unchecked_disabled:     "radio_unchecked_disabled",unchecked_onmouseover:  "radio_unchecked_onmouseover",checked_normal:         "radio_checked_normal",checked_disabled:       "radio_checked_disabled",checked_onmouseover:    "radio_checked_onmouseover"};function getElementOffsetScroll(oDomElement) {var win = Frame.Util.getWindowByElement(oDomElement);var nScrollLeft = win.document.body.scrollLeft;var nScrollTop = win.document.body.scrollTop; var oDomElementTemp = oDomElement;while(oDomElementTemp && oDomElementTemp.tagName && (oDomElementTemp.tagName.toLowerCase() != "body")){nScrollLeft += oDomElementTemp.scrollLeft;nScrollTop += oDomElementTemp.scrollTop;oDomElementTemp = oDomElementTemp.parentNode;}return {scrollLeft:nScrollLeft, scrollTop:nScrollTop};}function getElementRectangle(oDomElement) {var oOffsetScroll = getElementOffsetScroll(oDomElement);var nLeft = oDomElement.offsetLeft - oOffsetScroll.scrollLeft;var nTop = oDomElement.offsetTop - oOffsetScroll.scrollTop;var oDomElementTemp = oDomElement;var win = Frame.Util.getWindowByElement(oDomElement);var nBorderLeftWidth = parseInt(win.document.body.style.borderLeftWidth);var nBorderTopWidth = parseInt(win.document.body.style.borderTopWidth);if(isNaN(nBorderLeftWidth)) nBorderLeftWidth = 0;if(isNaN(nBorderTopWidth)) nBorderTopWidth = 0;while((oDomElementTemp = oDomElementTemp.offsetParent)){if(oDomElementTemp.tagName.toLowerCase() == "body" && Frame.RunState.Navigator.Type == "Firefox"){nLeft += oDomElementTemp.clientLeft + nBorderLeftWidth;nTop += oDomElementTemp.clientTop + nBorderTopWidth;}else if(oDomElementTemp.tagName.toLowerCase() == "body" && Frame.RunState.Navigator.Type == "Chrome"){nLeft += oDomElementTemp.offsetLeft;nTop += oDomElementTemp.offsetTop;}else{nLeft += (oDomElementTemp.offsetLeft + oDomElementTemp.clientLeft);nTop += (oDomElementTemp.offsetTop + oDomElementTemp.clientTop);}}var nRight = nLeft + oDomElement.offsetWidth-1;var nBottom = nTop + oDomElement.offsetHeight-1;return {left:nLeft, top:nTop, right:nRight, bottom:nBottom};}function isInElementRectangle(oDomElement, nMouseX, nMouseY){var oRectangle = getElementRectangle(oDomElement);return (nMouseX >= oRectangle.left && nMouseX <= oRectangle.right && nMouseY >= oRectangle.top && nMouseY <= oRectangle.bottom);}function convertMousePosition(oDomReference, nMouseClientX, nMouseClientY) {var win = Frame.Util.getWindowByElement(oDomReference);var aOffsetLeft = {IE:win.document.body.clientLeft, Chrome:0, Firefox:0};var aOffsetTop = {IE:win.document.body.clientTop, Chrome:0, Firefox:0};var nOffsetLeft = (aOffsetLeft[sNavigatorType]||0);var nOffsetTop = (aOffsetTop[sNavigatorType]||0);var sNavigatorType = Frame.RunState.Navigator.Type;var oOffsetScroll = getElementOffsetScroll(oDomReference);var nMouseX = nMouseClientX + nOffsetLeft + oOffsetScroll.scrollLeft;var nMouseY = nMouseClientY + nOffsetTop + oOffsetScroll.scrollTop;return {x:nMouseX, y:nMouseY};}function setElementPosition(oDomElement, oDomReference, nMouseClientX, nMouseClientY) {var win = Frame.Util.getWindowByElement(oDomElement);var oOffsetScroll = getElementOffsetScroll(oDomReference);var oMousePosition = convertMousePosition(oDomReference, nMouseClientX, nMouseClientY);var sNavigatorType = Frame.RunState.Navigator.Type;var aOffsetLeft = {IE:(-win.document.body.clientLeft), Firefox:0, Chrome:0};var aOffsetTop = {IE:(-win.document.body.clientTop), Firefox:0, Chrome:0};var nOffsetLeft = (aOffsetLeft[sNavigatorType]||0);var nOffsetTop = (aOffsetTop[sNavigatorType]||0);oDomElement.style.left = (oMousePosition.x - oOffsetScroll.scrollLeft + win.document.body.scrollLeft + nOffsetLeft) + "px";oDomElement.style.top = (oMousePosition.y - oOffsetScroll.scrollTop + win.document.body.scrollTop + nOffsetTop) + "px";}function offset(elem,type){var value = 0;var self = elem;while(elem){value += Math.abs(elem['offset' + type]);if(elem.currentStyle && elem.currentStyle.hasLayout && elem !== self){value += elem['client' + type];}elem = elem.offsetParent;}return value;}function log(sMessage, sType){var Frame = window.Frame||top.Frame;Frame && Frame.log && Frame.log(sMessage, sType, "TreeView");}function TreeView(oDomContainer, sXml, fnGetText, oOption) {log("生成TreeView开始。", "info");var aClassName, option = {type:"", unfold:1, width:null, height:null, sort:null, ondrag:null, ondrop:null, onselect:null, ondelete:null };var sOptionDefined = ""; var sOptionUnDefined = "";for(var i in oOption){if(i in option){sOptionDefined += "\r\n" + i + ":" + oOption[i].toString();option[i] = oOption[i];}else{sOptionUnDefined += "\r\n" + i + ":" + oOption[i].toString();}}("" != sOptionDefined) && log("选项参数: " + sOptionDefined, "info");("" != sOptionUnDefined) && log("发现未约定的选项参数: " + sOptionUnDefined, "warn");var oTreeView = {aVisibleNodes:null,oSelectedLast:null,oNodeChecked:null, oNodeSelecting:null, oNodeSelected:null, aNodeSelectedMemory:[],aNodeChecked:null, oNodeFocus:null,hTimeSelect:null,bFocus:false};var fnSort = option.sort; var fnOnDrag = option.ondrag||function(oTreeNodeSource, oTreeNodeTarget){return true;};var fnOnDrop = option.ondrop; var fnOnDelete = option.ondelete||function(oTreeNodeSelected){return true;};var fnOnSelect = option.onselect||function(oTreeNodeSelected){};var nExpandDepth = option.unfold;var sTreeViewType = option.type;if(!("" === sTreeViewType || "checkbox" === sTreeViewType || "radio" === sTreeViewType)){sTreeViewType = "";}var win = Frame.Util.getWindowByElement(oDomContainer);try{win.document.execCommand("BackgroundImageCache", false, true);}catch(e){};var clearTimeout = win.clearTimeout;var setTimeout = win.setTimeout;var schedule = (function(){var hTimer = null;return (function(fnSchedule, nSchedule){hTimer && clearTimeout(hTimer);hTimer = setTimeout(fnSchedule, nSchedule);});})();var oDomDivContainer = win.document.createElement("DIV");var oDomDivMainWindow = win.document.createElement("DIV");oDomContainer.appendChild(oDomDivContainer);oDomDivContainer.appendChild(oDomDivMainWindow);oDomDivContainer.className="TreeView";if(null != option.width) {oDomDivContainer.style.width=option.width;}if(null != option.height) {oDomDivContainer.style.height=option.height;}this.setWidth=function(sWidth){oDomDivContainer.style.width=sWidth;};this.setHeight=function(sHeight){oDomDivContainer.style.height=sHeight;};oDomDivContainer.ondragstart=function(){return false;};oDomDivMainWindow.className=oTreeView.bFocus?"main_focus":"main_blur";var aFnKeyProc = {"up":           fnKeyOnUp, "down":         fnKeyOnDown, "left":         fnKeyOnLeft, "right":        fnKeyOnRight, "space":        fnKeySpace, "shift_up":     fnKeyShiftUp, "shift_down":   fnKeyShiftDown, "shift_left":   fnKeyShiftLeft, "shift_right":  fnKeyShiftRight };option.ondelete && (aFnKeyProc["delete"] = fnKeyOnDelete);  var oKeymap = new Keymap({"default":function(oDomTarget, sKeyName, e){return (oTreeView.bFocus&&aFnKeyProc[sKeyName])?aFnKeyProc[sKeyName]():true;}});oKeymap.install(win.document); function fnKeyOnUp(){var oNode = oTreeView.oNodeSelecting.getPreviousVisibleNode();while(oNode && oNode.isDisabled()){oNode = oNode.getPreviousVisibleNode();}return oNode?(oNode.selectAndFireSelectEventSchedule()&&false):true;}function fnKeyOnDown(){var oNode = oTreeView.oNodeSelecting.getNextVisibleNode();while(oNode && oNode.isDisabled()){oNode = oNode.getNextVisibleNode();}return oNode?(oNode.selectAndFireSelectEventSchedule()&&false):true;}function fnKeyOnLeft(){var oNode = oTreeView.oNodeSelecting;if(oNode.isUnFold()){oNode.fold();return false;}else{return ((oNode=oNode.parentNode) && !oNode.isDisabled())?(oNode.selectAndFireSelectEventSchedule() && false):true;}}function fnKeyOnRight(){var oNode = oTreeView.oNodeSelecting;if(oNode.isFold()){oNode.unfold();return false;}else{return ((oNode=oNode.firstChild) && !oNode.isDisabled())?(oNode.selectAndFireSelectEventSchedule() && false):true;}}function fnKeyOnDelete(){var oNodeSelecting = oTreeView.oNodeSelecting;if(oNodeSelecting && fnOnDelete(oNodeSelecting.data)){if(oNodeSelecting.isRoot()){oNodeSelecting.oDomDivTreeContainer.innerHTML = "";}else{var oNode = oNodeSelecting.nextSibling||oNodeSelecting.parentNode; oNodeSelecting.remove();oNode && oNode.selectAndFireSelectEventSchedule();}}}function fnKeySpace(){var oNodeSelecting = oTreeView.oNodeSelecting;!oNodeSelecting.isDisabled() && oNodeSelecting.OnCheckboxRadioClick();}function fnKeyShiftUp() {("checkbox" === sTreeViewType) && oTreeView.oNodeSelecting && oTreeView.oNodeSelecting.OnCheckboxRadioClick(); var oNode = oTreeView.oNodeSelecting.previousSibling;while(oNode && oNode.isDisabled()){oNode = oNode.previousSibling;}oNode && oNode.selectAndFireSelectEventSchedule();}function fnKeyShiftDown() {("checkbox" === sTreeViewType) && oTreeView.oNodeSelecting && oTreeView.oNodeSelecting.OnCheckboxRadioClick(); var oNode = oTreeView.oNodeSelecting.nextSibling;while(oNode && oNode.isDisabled()){oNode = oNode.nextSibling;}oNode && oNode.selectAndFireSelectEventSchedule();}function fnKeyShiftLeft(){return true;}function fnKeyShiftRight(){return true;}function focus(){oTreeView.bFocus = true;oDomDivMainWindow.className="main_focus";}function blur(){oTreeView.bFocus = false;oDomDivMainWindow.className="main_blur";}Frame.EventHandler.add(win.document.body, "mousedown", function(e){blur();});Frame.EventHandler.add(oDomDivContainer, "mousedown", function(e) {e.stopPropagation();focus();});var oRoot = TreeView.makeXmlTree(sXml, fnSort);this.deleteSelectedNode = fnKeyOnDelete;this.focus = focus;this.disable = function(fnDisable){if(!oTreeViewRoot){return;}oTreeViewRoot.disable(fnDisable);var aVisibleAvailableNodes = oTreeViewRoot.getVisibleAvailableNodes();aVisibleAvailableNodes[0] && aVisibleAvailableNodes[0].selectAndFireSelectEvent();}this.check = function(fnCheck){oTreeViewRoot && oTreeViewRoot.checkNodes(fnCheck);}this.getCheckedNodes = function(){var aCheckedNodes = [], aNodes = [];oTreeViewRoot && (aNodes = oTreeViewRoot.getCheckedNodes());for(var i = 0; i< aNodes.length; i++){aCheckedNodes.push(aNodes[i].data);}return aCheckedNodes;};this.getSelectedNode = function() {return (oTreeView.oNodeSelected.data);}var oTreeViewRoot = (function(oTreeNode){if(null == oTreeNode) return null;var oTreeViewNode = new TreeViewNode();oTreeViewNode.data = oTreeNode;for(var i=0; i< oTreeNode.childNodes.length; i++){oTreeViewNode.childNodes.push(arguments.callee(oTreeNode.childNodes[i]));}return oTreeViewNode;})(oRoot);if(null == oTreeViewRoot){return;}(function(oTreeViewNode, nExpandDepth){oTreeViewNode.sPuckerStatus = (0==oTreeViewNode.childNodes.length?"none":nExpandDepth>0?"open":"closed");for(var i=0; i< oTreeViewNode.childNodes.length; i++){arguments.callee(oTreeViewNode.childNodes[i], nExpandDepth-1);}})(oTreeViewRoot, nExpandDepth);function getDomDivTreeItem(oDomDivTreeContainer){return oDomDivTreeContainer.firstChild;}function getDomDivSubtreeContainer(oDomDivTreeContainer){return oDomDivTreeContainer.firstChild.nextSibling;};function getDomDivChildTreeContainers(oDomDivTreeContainer){return getDomDivSubtreeContainer(oDomDivTreeContainer).childNodes;}function getDomSpanPucker(oDomDivTreeContainer){return oDomDivTreeContainer.firstChild.firstChild;}function getDomSpanCheckboxRadio(oDomDivTreeContainer){return getDomSpanPucker(oDomDivTreeContainer).nextSibling;}function getDomAnchorText(oDomDivTreeContainer){return oDomDivTreeContainer.firstChild.childNodes[("" == sTreeViewType?1:2)];}function getDomDivTreeContainer(oDomPuckerOrCheckbox){return oDomPuckerOrCheckbox.parentNode.parentNode;}function drag(nDomX, nDomY, nMouseX, nMouseY, oTreeViewNodeSource) {var nDeltaX = nMouseX - nDomX;var nDeltaY = nMouseY - nDomY;var oTreeViewNodeTarget, aTimeoutHandle = [], bAllowToDrop = false;var oDomReference = getDomAnchorText(oTreeViewNodeSource.oDomDivTreeContainer);var oDomDiv = win.document.createElement("DIV");oDomDiv.innerHTML = "<NOBR><SPAN>"+fnGetText(oTreeViewNodeSource.data)+"</SPAN></NOBR>";oDomDiv.className = "TreeView_drag";win.document.body.appendChild(oDomDiv);oDomDiv.style.cursor = "not-allowed";setElementPosition(oDomDiv, oDomReference, nDomX, nDomY);if(oDomDiv.setCapture){oDomDiv.setCapture();}Frame.EventHandler.add(win.document, "mousemove", fnMoveHandler);Frame.EventHandler.add(win.document, "mouseup", fnUpHandler);function fnMoveHandler(e){e.preventDefault();for(var i=0; i < aTimeoutHandle.length; i++){clearTimeout(aTimeoutHandle[i]);}aTimeoutHandle = [];setElementPosition(oDomDiv, oDomReference, e.clientX - nDeltaX, e.clientY - nDeltaY);oTreeViewNodeTarget = oTreeViewRoot.getDropTarget(e.clientX, e.clientY);bAllowToDrop = (oTreeViewNodeTarget &&(oTreeViewNodeSource!==oTreeViewNodeTarget) && (oTreeViewNodeSource.parentNode!==oTreeViewNodeTarget) && (!oTreeViewNodeSource.isForefather(oTreeViewNodeTarget)) &&(fnOnDrag(oTreeViewNodeSource.data, oTreeViewNodeTarget.data)));if(bAllowToDrop){oDomDiv.style.cursor = "default";oTreeViewNodeTarget.focus();if("closed" == oTreeViewNodeTarget.sPuckerStatus){aTimeoutHandle.push(setTimeout(function(){oTreeViewNodeTarget.unfold();}, 500)); }}else{oTreeView.oNodeSelected.focus(); oDomDiv.style.cursor = "not-allowed";}}function fnUpHandler(e){e.preventDefault();if(oDomDiv.releaseCapture){oDomDiv.releaseCapture();}for(var i=0; i < aTimeoutHandle.length; i++){clearTimeout(aTimeoutHandle[i]);}aTimeoutHandle = [];Frame.EventHandler.remove(win.document, "mousemove", fnMoveHandler);Frame.EventHandler.remove(win.document, "mouseup", fnUpHandler);win.document.body.removeChild(oDomDiv);oDomDiv = null;if(bAllowToDrop && fnOnDrop(oTreeViewNodeSource.data, oTreeViewNodeTarget.data)){oTreeViewNodeSource.parentNode.removeChild(oTreeViewNodeSource);oTreeViewNodeTarget.appendChild(oTreeViewNodeSource);}oTreeView.oNodeSelected.focus();}}function TreeViewNode(){this.parentNode = null;this.childNodes = [];this.firstChild = null;this.lastChild = null;this.previousSibling = null;this.nextSibling = null;this.data = null;this.oDomDivTreeContainer = null; this.sPuckerStatus = "open"; this.sCheckStatus = "unchecked"; this.bDisabled = false;this.bMouseOver = false; this.bSelected = false;this.bFocus = false;}TreeViewNode.prototype.isRoot = function(){return (oTreeViewRoot == this); }TreeViewNode.prototype.isLeaf = function(){return (0 == this.childNodes.length);}TreeViewNode.prototype.isBranch = function(){return (0 < this.childNodes.length);}TreeViewNode.prototype.isFold = function(){return ("closed" === this.sPuckerStatus);}TreeViewNode.prototype.isUnFold = function(){return ("open" === this.sPuckerStatus);}TreeViewNode.prototype.isChecked = function(){return ("checked" === this.sCheckStatus);}TreeViewNode.prototype.isForefather = function(oTreeViewNode){var oTreeViewNodeTemp = oTreeViewNode;while((oTreeViewNodeTemp= oTreeViewNodeTemp.parentNode)){if(this == oTreeViewNodeTemp){return true;}}return false;}TreeViewNode.prototype.fireSelectEvent = function(){if(this != oTreeView.oNodeSelected){if((false === fnOnSelect(this.data)) && oTreeView.oNodeSelected && oTreeView.oNodeSelected.isAvailable()){oTreeView.oNodeSelected.focus();oTreeView.oNodeSelected.select();}else{oTreeView.oNodeSelected = this;oTreeView.aNodeSelectedMemory.push(oTreeView.oNodeSelected); }}}TreeViewNode.prototype.fireSelectEventSchedule = function(){var oNodeSelected = this;schedule(function(){oNodeSelected.fireSelectEvent();}, 500);}TreeViewNode.prototype.selectAndFireSelectEventSchedule = function(){this.focus();this.select();this.fireSelectEventSchedule();}TreeViewNode.prototype.selectAndFireSelectEvent = function(){this.focus();this.select();this.fireSelectEvent();}TreeViewNode.prototype.remove = function(){this.parentNode.removeChild(this);}TreeViewNode.prototype.unselect = function(){this.bSelected = false;this.updateAnchorText();}TreeViewNode.prototype.select = function(){oTreeView.oNodeSelecting && oTreeView.oNodeSelecting.unselect();oTreeView.oNodeSelecting = this;this.bSelected = true;this.updateAnchorText();this.scrollIntoSight();("radio" === sTreeViewType)&&this.check();}TreeViewNode.prototype.getNextVisibleNode = function(){!oTreeView.aVisibleNodes && (oTreeView.aVisibleNodes = oTreeViewRoot.getVisibleNodes());var aVisibleNodes = oTreeView.aVisibleNodes;for(var i = 0 ; i < aVisibleNodes.length ; i ++ ) {if((this == aVisibleNodes[i])){break;}}return aVisibleNodes[i+1];}TreeViewNode.prototype.getPreviousVisibleNode = function(){!oTreeView.aVisibleNodes && (oTreeView.aVisibleNodes = oTreeViewRoot.getVisibleNodes());var aVisibleNodes = oTreeView.aVisibleNodes;for(var i = 0 ; i < aVisibleNodes.length ; i ++ ) {if((this == aVisibleNodes[i])){break;}}return aVisibleNodes[i-1];}TreeViewNode.prototype.scrollIntoSight = function() {var oDomAnchor = getDomAnchorText(this.oDomDivTreeContainer);var oDomAnchorRect = getElementRectangle(oDomAnchor);var oDomDivContainerRect = getElementRectangle(oDomDivMainWindow);var nOffsetTop = oDomAnchorRect.top - oDomDivContainerRect.top;var nOffsetBottom = oDomAnchorRect.bottom - oDomDivContainerRect.top + oDomAnchor.offsetHeight;if(nOffsetBottom > (oDomDivContainer.clientHeight + oDomDivContainer.scrollTop)){oDomDivContainer.scrollTop = nOffsetBottom - oDomDivContainer.clientHeight;}if(nOffsetTop < (oDomDivContainer.scrollTop)){oDomDivContainer.scrollTop = nOffsetTop;}}TreeViewNode.prototype.blur = function() {this.bFocus = false;this.updateAnchorText();}TreeViewNode.prototype.focus = function() {oTreeView.oNodeFocus && oTreeView.oNodeFocus.blur();oTreeView.oNodeFocus = this;this.bFocus = true;this.updateAnchorText();}TreeViewNode.prototype.updateAnchorText = function(){var sClassName = "";if(this.bFocus && this.bSelected){sClassName = "focus_selected"}else if(this.bFocus){sClassName = "focus";}else if(this.bSelected){sClassName = "selected";}else{sClassName = "normal"; }this.oDomDivTreeContainer && (getDomAnchorText(this.oDomDivTreeContainer).className = sClassName);}TreeViewNode.prototype.isVisible = function(){var oTreeViewNode = this;while(oTreeViewNode = oTreeViewNode.parentNode){if("closed" == this.sPuckerStatus){return false;}}return true;}TreeViewNode.prototype.getVisibleNodes = function() {var aTreeViewNodes = [this];if(this.childNodes.length > 0 && this.sPuckerStatus == "open"){for(var i=0; i<this.childNodes.length; i++){aTreeViewNodes = aTreeViewNodes.concat(arguments.callee.apply(this.childNodes[i]));}}return aTreeViewNodes;}TreeViewNode.prototype.isAvailable = function() {return (!this.isDisabled() && this.oDomDivTreeContainer);}TreeViewNode.prototype.getVisibleAvailableNodes = function() {var aNodes = [];var aVisibleNodes = this.getVisibleNodes();for(var i=0; i<aVisibleNodes.length; i++){aVisibleNodes[i].isAvailable() && aNodes.push(aVisibleNodes[i]);}return aNodes;}TreeViewNode.prototype.getNodes = function(fnIsNeeded) {var aNodes=[];(true === fnIsNeeded.apply(this)) && (aNodes = aNodes.concat([this]));for(var i=0; i< this.childNodes.length; i++){aNodes = aNodes.concat(arguments.callee.apply(this.childNodes[i], arguments));}return aNodes;}TreeViewNode.prototype.getCheckedNodes = function(){return this.getNodes(this.isChecked);}TreeViewNode.prototype.appendChild = function(oTreeViewNode){this.childNodes.push(oTreeViewNode);this.sPuckerStatus = "open";this.build();}TreeViewNode.prototype.removeChild = function(oTreeViewNode){for(var i=0; i< this.childNodes.length; i++){if(oTreeViewNode === this.childNodes[i]){break;}}if(i === this.childNodes.length){return null;}this.childNodes.splice(i, 1);this.build();oTreeViewNode.oDomDivTreeContainer = null;return oTreeViewNode;}TreeViewNode.prototype.getDropTarget = function(nMouseX, nMouseY){var oTreeViewNode = null;if (!isInElementRectangle(this.oDomDivTreeContainer, nMouseX, nMouseY)) return;if(isInElementRectangle(getDomAnchorText(this.oDomDivTreeContainer), nMouseX, nMouseY)){oTreeViewNode = this;}else if("open" == this.sPuckerStatus){for(var i=0; i< this.childNodes.length; i++){oTreeViewNode = oTreeViewNode || this.childNodes[i].getDropTarget(nMouseX, nMouseY);}}return oTreeViewNode;}TreeViewNode.prototype.makeInnerHTML = function(){var sContent = fnGetText(this.data);var sTitle = sContent;this.sContent = sContent;this.sTitle = sTitle;var sInnerHTML = '<DIV class="item"><SPAN></SPAN>';if("" != sTreeViewType){sInnerHTML += '<SPAN></SPAN>';}sInnerHTML += ('<A href="javascript:void(0);" title="' + sTitle + '">' + sContent + '</A></DIV>');if(this.childNodes.length >0){sInnerHTML += '<DIV class="subtree-container">';for(var i=0; i< this.childNodes.length; i++){sInnerHTML += '<DIV>' + this.childNodes[i].makeInnerHTML() + '</DIV>';}sInnerHTML += '</DIV>';}return sInnerHTML;}TreeViewNode.prototype.attachDomPointer = function(){if(this.childNodes.length >0){var aDomDivChildTreeContainers = getDomDivChildTreeContainers(this.oDomDivTreeContainer);for(var i=0; i< this.childNodes.length; i++){this.childNodes[i].oDomDivTreeContainer = aDomDivChildTreeContainers[i];arguments.callee.call(this.childNodes[i]);}}}TreeViewNode.prototype.updatePucker= function(){var sClassName = "";if(this.isRoot()){sClassName = aPuckerClassName["root"];}else if(this.childNodes.length == 0){sClassName = aPuckerClassName["none"];}else if("closed" == this.sPuckerStatus || "open" == this.sPuckerStatus){sClassName = aPuckerClassName[this.sPuckerStatus];}else{sClassName = "open";}getDomSpanPucker(this.oDomDivTreeContainer).className = sClassName;}TreeViewNode.prototype.updateCheckStatus= function(){if("" != sTreeViewType){var sStatus = "normal";if(true == this.bMouseOver){sStatus = "onmouseover"}if(true == this.bDisabled){sStatus = "disabled"}this.oDomDivTreeContainer && (getDomSpanCheckboxRadio(this.oDomDivTreeContainer).className = ("radio"==sTreeViewType?aRadioClassName:aCheckboxClassName)[this.sCheckStatus + "_" + sStatus]);}}TreeViewNode.prototype.updateTreeContainer= function(){var sClassName = "";if(this == oTreeViewRoot){sClassName = "tree-container-root"}else if(this.parentNode.lastChild == this){sClassName = "tree-container-last";}else{sClassName = "tree-container";}this.oDomDivTreeContainer && (this.oDomDivTreeContainer.className = sClassName);}TreeViewNode.prototype.update = function(){this.updateTreeContainer();this.updatePucker();this.updateCheckStatus();if(this.bSelected){this.oDomDivTreeContainer && (getDomAnchorText(this.oDomDivTreeContainer).className = "selected");}if(this.childNodes.length >0){getDomDivSubtreeContainer(this.oDomDivTreeContainer).style.display = {open:"", closed:"none"}[this.sPuckerStatus];for(var i = 0; i< this.childNodes.length; i++){arguments.callee.call(this.childNodes[i]);}}}TreeViewNode.prototype.setCheckStatusDown = function(sCheckStatus, bSpread) {this.sCheckStatus = sCheckStatus;this.updateCheckStatus();if(bSpread && this.childNodes.length > 0){for(var i=0; i< this.childNodes.length; i++){this.childNodes[i].setCheckStatusDown(sCheckStatus, true);}}}TreeViewNode.prototype.adjustCheckStatusUp = function(){var oCount = {checked:0, unchecked:0, halfchecked:0};for(var i=0; i<this.childNodes.length; i++){oCount[this.childNodes[i].sCheckStatus]++;}if(0 == oCount.checked && 0 == oCount.halfchecked){this.sCheckStatus = "unchecked";}else if(this.childNodes.length == oCount.checked){this.sCheckStatus = "checked";}else{this.sCheckStatus = "halfchecked";}this.updateCheckStatus();if(null != this.parentNode){this.parentNode.adjustCheckStatusUp();}}TreeViewNode.prototype.setCheckStatus= function(sCheckStatus, bSpread) {if(null == bSpread){bSpread = true;}this.setCheckStatusDown(sCheckStatus, bSpread);if(bSpread && null != this.parentNode){this.parentNode.adjustCheckStatusUp();}}TreeViewNode.prototype.fold = function() {if(!this.isUnFold()){return;}this.sPuckerStatus = "closed";this.updatePucker();getDomDivSubtreeContainer(this.oDomDivTreeContainer).style.display = "none";var oNodeSelecting = oTreeView.oNodeSelecting;if(oNodeSelecting && this.isForefather(oNodeSelecting)){this.focus();this.select();}oTreeView.aVisibleNodes = null;}TreeViewNode.prototype.unfold = function() {if(!this.isFold()){return;}this.sPuckerStatus = "open";this.updatePucker();getDomDivSubtreeContainer(this.oDomDivTreeContainer).style.display = "";oTreeView.aVisibleNodes = null;}TreeViewNode.prototype.reversePuckerStatus = function(){if(this.isFold()){this.unfold();}else if(this.isUnFold()){this.fold();}}TreeViewNode.prototype.OnCheckboxRadioClick = function(){if(this.bDisabled){return;}if("radio" == sTreeViewType){this.selectAndFireSelectEvent();}else{this.setCheckStatus({unchecked:"checked", checked:"unchecked", halfchecked:"checked"}[this.sCheckStatus], true);}}TreeViewNode.prototype.OnCheckboxMouseOut= function(){this.bMouseOver=false;this.updateCheckStatus();}TreeViewNode.prototype.OnCheckboxMouseOver = function(){this.bMouseOver=true;this.updateCheckStatus();}TreeViewNode.prototype.OnCheckboxMouseOver = function(){this.bMouseOver=true;this.updateCheckStatus();}TreeViewNode.prototype.addEventHandler = function(){var oTreeViewNode = this;if("" != sTreeViewType){var oDomSpanCheckboxRadio = getDomSpanCheckboxRadio(this.oDomDivTreeContainer);oDomSpanCheckboxRadio.onclick = function(){!oTreeViewNode.isDisabled() && oTreeViewNode.OnCheckboxRadioClick();}oDomSpanCheckboxRadio.onmouseover = function(){!oTreeViewNode.isDisabled() && oTreeViewNode.OnCheckboxMouseOver();}oDomSpanCheckboxRadio.onmouseout = function(){!oTreeViewNode.isDisabled() && oTreeViewNode.OnCheckboxMouseOut();}oDomSpanCheckboxRadio = null;}if(oTreeViewNode.childNodes.length > 0){getDomSpanPucker(this.oDomDivTreeContainer).onclick = function(){oTreeViewNode.reversePuckerStatus();}for(var i=0; i< oTreeViewNode.childNodes.length; i++){oTreeViewNode.childNodes[i].addEventHandler();}}var oDomAnchorText = getDomAnchorText(this.oDomDivTreeContainer);oDomAnchorText.onmouseover = function(){(this.className == "normal") && (this.className = "");}oDomAnchorText.onclick = function(){!oTreeViewNode.isDisabled() && oTreeViewNode.selectAndFireSelectEvent();}oDomAnchorText.ondblclick = function() {!oTreeViewNode.isDisabled() && oTreeViewNode.reversePuckerStatus();}fnOnDrop && Frame.EventHandler.add(oDomAnchorText, "mousedown", function(e){e.preventDefault();var oRectangle = getElementRectangle(this);var nMouseClientX = e.clientX;var nMouseClientY = e.clientY;Frame.EventHandler.add(win.document, "mousemove", fnMoveHandler);Frame.EventHandler.add(win.document, "mouseup", fnUpHandler);function fnMoveHandler(e){e.preventDefault();if((Math.abs(e.clientX-nMouseClientX) + Math.abs(e.clientY-nMouseClientY)) > 3){fnUpHandler(e);drag(oRectangle.left, oRectangle.top, nMouseClientX, nMouseClientY, oTreeViewNode);}}function fnUpHandler(e){Frame.EventHandler.remove(win.document, "mousemove", fnMoveHandler);Frame.EventHandler.remove(win.document, "mouseup", fnUpHandler);}});oDomAnchorText = null;}TreeViewNode.prototype.buildRelations = function(){if(this.childNodes.length >0){fnSort && this.childNodes.sort(function(TreeViewNode1, TreeViewNode2){return fnSort(TreeViewNode1.data, TreeViewNode2.data);});this.firstChild = this.childNodes[0];this.lastChild = this.childNodes[this.childNodes.length-1];for(var i = 0; i< this.childNodes.length; i++){this.childNodes[i].parentNode = this;this.childNodes[i].previousSibling = (i>0)?this.childNodes[i-1]:null;this.childNodes[i].nextSibling = (i<(this.childNodes.length-1))?this.childNodes[i+1]:null;arguments.callee.call(this.childNodes[i]);}}else{this.firstChild = null;this.lastChild = null;}}TreeViewNode.prototype.checkNodes = function(fnCheck){var bCheck = fnCheck(this.data); var sCheckStatus = "nochange";if(true === bCheck){sCheckStatus = "checked"}if(false === bCheck){sCheckStatus = "unchecked"}if("checked" == sCheckStatus||"unchecked" == sCheckStatus){this.setCheckStatus(sCheckStatus, {checkbox:true, radio:false}[sTreeViewType]);}for(var i=0; i< this.childNodes.length; i++){arguments.callee.apply(this.childNodes[i], arguments);}}TreeViewNode.prototype.check = (function() {function checkTreeViewNode(){}function checkTreeViewNodeRadio(){oTreeView.oNodeChecked && oTreeView.oNodeChecked.setCheckStatus("unchecked", false);this.setCheckStatus("checked", false);oTreeView.oNodeChecked = this;}function checkTreeViewNodeCheckbox(){this.setCheckStatus("checked", true);}return {"":checkTreeViewNode, "radio":checkTreeViewNodeRadio, "checkbox":checkTreeViewNodeCheckbox}[sTreeViewType]||null;})();TreeViewNode.prototype.isDisabled = function(fnDisable){return (true === this.bDisabled);}TreeViewNode.prototype.disable = function(fnDisable){this.bDisabled = (true === fnDisable(this.data));this.updateCheckStatus();for(var i=0; i< this.childNodes.length; i++){arguments.callee.apply(this.childNodes[i], arguments);}}TreeViewNode.prototype.build = function(){log("树生成开始。", "info");oTreeView.aVisibleNodes = null;log("正在初始化树节点关系。", "info");this.buildRelations();log("正在设置DOM innerHTML。", "info");this.oDomDivTreeContainer.innerHTML = this.makeInnerHTML();log("正在更新DOM引用。", "info");this.attachDomPointer();log("正在添加事件处理。", "info");this.addEventHandler();log("正在更新显示。", "info");this.update();log("树生成结束。", "info");}oDomDivMainWindow.innerHTML = '<DIV></DIV><DIV class="bottom"></DIV>';oTreeViewRoot.oDomDivTreeContainer = oDomDivMainWindow.firstChild;oTreeViewRoot.build();oTreeViewRoot.selectAndFireSelectEvent();log("生成TreeView结束。", "info");}(function(){function TreeNode(oTreeNode, oParentNode, fnCompare) {this.parentNode = null;this.childNodes = [];this.firstChild = null; this.lastChild = null; this.previousSibling = null; this.nextSibling = null; this.attributes = {}; if(!(null != oTreeNode&&(oTreeNode instanceof TreeNode))){return;}if( (null != oParentNode&&(oParentNode instanceof TreeNode))){this.parentNode = oParentNode;}for(var i in oTreeNode.attributes){this.attributes[i] = oTreeNode.attributes[i];}for(var i in oTreeNode){var sType = typeof oTreeNode[i];if("string" == sType || "number" == sType || "boolean" == sType){this[i] = oTreeNode[i];}}var nChildNodesLength = oTreeNode.childNodes.length;if(nChildNodesLength > 0){for(var i=0; i < nChildNodesLength; i++){this.childNodes.push(new TreeNode(oTreeNode.childNodes[i], this, fnCompare));}if(null != fnCompare) this.childNodes.sort(fnCompare);this.firstChild = this.childNodes[0];this.lastChild = this.childNodes[nChildNodesLength-1];}}TreeNode.prototype.toXmlString = function(sSeparator) {if(null == sSeparator){sSeparator = "";}var sXml = sSeparator + '<' + this.tagName;for(var i in this.attributes){sXml += ' ' + i + '="' + this.attributes[i] + '"';}sXml += '>';if(this.childNodes.length > 0){for(var i=0; i< this.childNodes.length; i++){sXml += "\r\n" + arguments.callee.call(this.childNodes[i],sSeparator+"  ");}sXml += "\r\n" + sSeparator;}sXml += '</' + this.tagName + '>';return sXml;}function analyse(sXml){sXml = sXml.replace(/[\r\n\t]/g, "");function analyseNext(){   for(var i=0; i< aNode.length; i++){if(aNode[i].pattern.test(sXml.substring(nPosTagStart))){if(!aNode[i].analyse()){return false;}break;}}if(i == aNode.length){log("无法识别的 xml子串: " + sXml.substring(nPosTagStart) + "。", "error");return false;}return true;}var nPosTagStart = 0;var aStack = [];var oRoot = new TreeNode();function analyseNode(){var nAttributeOffset = 0;var sData = sXml.substring(nPosTagStart).replace(this.pattern,"$1");var oTreeNodeParent = aStack[aStack.length-1];if("tagHalfOpen" == this.type||"tagOpenClose" == this.type||"text" == this.type){   var oTreeNode = new TreeNode();oTreeNodeParent.childNodes.push(oTreeNode);oTreeNodeParent.firstChild = oTreeNodeParent.childNodes[0];oTreeNodeParent.lastChild = oTreeNodeParent.childNodes[oTreeNodeParent.childNodes.length-1];oTreeNode.parentNode = oTreeNodeParent;if("tagHalfOpen" == this.type||"tagOpenClose" == this.type){var sAttributes = sXml.substring(nPosTagStart).replace(this.pattern,"$2");nAttributeOffset = sAttributes.length;if(nAttributeOffset >0){var aAttributes = sAttributes.match(/[a-zA-Z_]{1}\w*=\".*?\"/g); //"for(var i=0; i< aAttributes.length; i++){var sTemp = aAttributes[i].split("=")[1];oTreeNode.attributes[aAttributes[i].split("=")[0]] = sTemp.substring(1, sTemp.length-1);}}}oTreeNode.nodeType = this.nodeType;oTreeNode.nodeTypeString = this.nodeTypeString;if("element" == this.nodeTypeString){oTreeNode.nodeName = sData;oTreeNode.nodeValue = null;oTreeNode.tagName = sData;}else if("text" == this.nodeTypeString){oTreeNode.nodeName = "#text";oTreeNode.nodeValue = sData;oTreeNode.data = sData;oTreeNode.length = sData.length;}if("tagHalfOpen" == this.type){aStack.push(oTreeNode);}}else if("tagHalfClose" == this.type){if(sData == oTreeNodeParent.tagName){aStack.pop();}else{log("分析到标签" + sData + "时发生错误，期待一个关闭标签: " + oTreeNodeParent.tagName + "。", "error");return false;}}nPosTagStart += (sData.length + nAttributeOffset + this.offset);return true;}var aNode = [{type:"tagHalfOpen",    nodeType:0x1,   nodeTypeString:"element",   pattern: /^<([a-zA-Z_]{1}\w*)(( [a-zA-Z_]{1}\w*=\"[^=\"]*?\")*)>.*/,       offset:2,   analyse:analyseNode},{type:"tagOpenClose",   nodeType:0x1,   nodeTypeString:"element",   pattern: /^<([a-zA-Z_]{1}\w*)(( [a-zA-Z_]{1}\w*=\"[^=\"]*?\")*)\/>.*/,     offset:3,   analyse:analyseNode},{type:"tagHalfClose",   nodeType:0x1,   nodeTypeString:"element",   pattern: /^<\/([a-zA-Z0-9_]{1}[\w]*)>.*/,     offset:3,   analyse:analyseNode},{type:"text",           nodeType:0x3,   nodeTypeString:"text",      pattern: /^([^<].*?)<.*/,                     offset:0,   analyse:analyseNode}];aStack.push(oRoot);if(null == sXml || "" == sXml) return null;var bSuccess = true;while(bSuccess && nPosTagStart < sXml.length){bSuccess = analyseNext();}if(bSuccess && 1 != oRoot.childNodes.length){log("XML树只能有一个根结点。", "error");bSuccess = false;}if(bSuccess){var oRealRoot = aStack.pop().childNodes[0];oRealRoot.parentNode = null;return oRealRoot; }else{return null;}}var aXmlTreeCache = [];TreeView.makeXmlTree = function(sXml, fnCompare) {log("将XML字符串转换为XML树开始。", "info");log("输入参数: \r\nxml: " + sXml + "\r\nsort: " + fnCompare + "。", "info");var oXmlTreeRoot = null;var oRoot = aXmlTreeCache[sXml]||analyse(sXml);if(null != oRoot){aXmlTreeCache[sXml] = oRoot;oXmlTreeRoot = new TreeNode(oRoot, null, fnCompare);}log("将XML字符串转换为XML树结束。", "info");return oXmlTreeRoot; }})();function Keymap(bindings){this.map = {};if(bindings){for(var name in bindings) this.map[name.toLowerCase()] = bindings[name];}}Keymap.prototype.bind = function(key, func){this.map[key.toLowerCase()] = func;}Keymap.prototype.unbind = function(key){delete this.map[key.toLowerCase()];}Keymap.prototype.install = function(element){var keymap = this;function handler(event){return keymap.dispatch(event)}if(element.addEventListener){element.addEventListener("keydown", handler, false);element.addEventListener("keypress", handler, false);}else if(element.attachEvent){element.attachEvent("onkeydown", handler);element.attachEvent("onkeypress", handler);}else{element.onkeydown = element.onkeypress = handler;}}Keymap.keyCodeToFunctionKey = { 8:"backspace", 9:"tab", 13:"return", 19:"pause", 27:"escape",32:"space",33:"pageup", 34:"pagedown", 35:"end", 36:"home", 37:"left", 38:"up",39:"right", 40:"down", 44:"printscreen", 45:"insert", 46:"delete",112:"f1", 113:"f2", 114:"f3", 115:"f4", 116:"f5", 117:"f6", 118:"f7",119:"f8", 120:"f9", 121:"f10", 122:"f11", 123:"f12", 144:"numlock", 145:"scrolllock"};Keymap.keyCodeToPrintableChar = { 48:"0", 49:"1", 50:"2", 51:"3", 52:"4", 53:"5", 54:"6", 55:"7", 56:"8",57:"9", 59:";", 61:"=", 65:"a", 66:"b", 67:"c", 68:"d",69:"e", 70:"f", 71:"g", 72:"h", 73:"i", 74:"j", 75:"k", 76:"l", 77:"m",78:"n", 79:"o", 80:"p", 81:"q", 82:"r", 83:"s", 84:"t", 85:"u", 86:"v",87:"w", 88:"x", 89:"y", 90:"z", 107:"+", 109:"-", 110:".", 188:",",190:".", 191:"/", 192:"'", 219:"[", 220:"\\", 221:"]", 222:"\""};Keymap.prototype.dispatch = function(event){var e = event || window.event; var modifiers = "";var keyname = null;if(e.type == "keydown"){var code = e.keyCode;if(code == 16 || code == 17 || code == 18){return;}keyname = Keymap.keyCodeToFunctionKey[code];if(!keyname && (e.altKey || e.ctrlKey)){keyname = Keymap.keyCodeToPrintableChar[code];}if(keyname){if(e.altKey){modifiers += "alt_";}if(e.ctrlKey){modifiers += "ctrl_";}if(e.shiftKey){modifiers += "shift_";}}else{return;}}else if(e.type == "keypress"){if(e.altKey || e.ctrlKey){return;}if(e.charCode != undefined && e.charCode == 0){return;}var code = e.charCode || e.keyCode;keyname = String.fromCharCode(code);var lowercase = keyname.toLowerCase();if(keyname != lowercase){keyname = lowercase;modifiers = "shift_";}}var func = this.map[modifiers+keyname]||this.map["default"];if(func){var target = e.target;if(!target){target = e.srcElement;}if(true === func(target, modifiers+keyname, e)){return true;}if(e.stopPropagation){e.stopPropagation();}else{e.cancelBubble = true;}if(e.preventDefault){e.preventDefault();}else{e.returnValue = false;}return false;}}Widget.TreeView = TreeView;   })();})();